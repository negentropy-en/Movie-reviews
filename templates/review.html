{% extends "base.html" %}
{% block content %}

{% if error %}
  <p class="error">{{ error }}</p>
{% endif %}

<h1>{{ review.movie_title }}</h1>

<p class="muted">
  by <a href="/user/{{ review.user_id }}">{{ review.username }}</a>
  ({{ review.created_at }})
</p>

<div class="content-text block">{{ review.content }}</div>

<p>
  <strong>Classifications:</strong>
  {% if categories %}
    {% for c in categories %}
      {{ c.name }}{% if not loop.last %}, {% endif %}
    {% endfor %}
  {% else %} none {% endif %}
</p>

<p>
  <strong>Number of comments:</strong> {{ review.comment_count }}<br>
  <strong>Average rating:</strong> {{ review.avg_rating if review.avg_rating is not none else "-" }}
</p>

{% if session.user_id == review.user_id %}
  <p>
    <a href="/review/{{ review.id }}/edit">Edit review</a> |
    <a href="/review/{{ review.id }}/delete">Delete review</a>
  </p>
{% endif %}

<hr>

<h2>Comments</h2>

{% if comments %}
  {% for comment in comments %}
    <div class="block">
      <strong>{{ comment.username }}</strong>
      <span class="muted">({{ comment.created_at }})</span><br>
      Rating: {{ comment.rating }}/5
      <div class="content-text" style="margin-top:.5rem;">{{ comment.content }}</div>

      {% if session.user_id == comment.user_id %}
        <p style="margin-top:.5rem;">
          <a href="/comment/{{ comment.id }}/edit">Edit comment</a> |
          <a href="/comment/{{ comment.id }}/delete">Delete comment</a>
        </p>
      {% endif %}
    </div>
    {% if not loop.last %}<hr>{% endif %}
  {% endfor %}
{% else %}
  <p>No comments yet.</p>
{% endif %}

{% if session.user_id %}
  <h3>Add a new comment</h3>
  <form action="/comment/new" method="post" class="form">
    <fieldset>
      <label>Rating (1â€“5)</label>
      <input type="number" name="rating" min="1" max="5" required>
    </fieldset>
    <fieldset>
      <label>Comment</label>
      <textarea name="content" rows="4" required>{{ comment_text or '' }}</textarea>
    </fieldset>

    <input type="hidden" name="review_id" value="{{ review.id }}">
    <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">

    <div class="btn-row">
      <input type="submit" value="Send comment" class="btn-primary">
    </div>
  </form>
{% else %}
  <p><a href="/login">Log in</a> to comment.</p>
{% endif %}

{% endblock %}
